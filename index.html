<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f1a">
<title>×ª×§×¦×™×‘ ××©×¤×—×ª×™</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg:#0f0f1a;--bg2:#1a1a2e;--bg3:#0f0f1a;--acc:#00d4ff;--acc2:#0077ff;--border:#ffffff11;--text:#e0e0e0;--text2:#888;--inc:#00c853;--exp:#ff1744}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;direction:rtl;overscroll-behavior:none;transition:background 0.3s,color 0.3s}

/* THEMES */
body.t-dark{--bg:#0f0f1a;--bg2:#1a1a2e;--bg3:#0a0a12;--acc:#00d4ff;--acc2:#0077ff;--border:#ffffff11;--text:#e0e0e0;--text2:#888}
body.t-light{--bg:#f0f2f5;--bg2:#ffffff;--bg3:#e8eaf0;--acc:#0077ff;--acc2:#0055cc;--border:#e0e0e0;--text:#1a1a2e;--text2:#666}
body.t-gold{--bg:#0d0a00;--bg2:#1a1400;--bg3:#0d0a00;--acc:#ffd700;--acc2:#ff8c00;--border:#ffd70022;--text:#ffe88a;--text2:#a08030}
body.t-red{--bg:#1a0505;--bg2:#2a0808;--bg3:#150404;--acc:#ff4444;--acc2:#cc0000;--border:#ff444422;--text:#ffcccc;--text2:#aa6666}
body.t-orange{--bg:#1a0d00;--bg2:#2a1500;--bg3:#150a00;--acc:#ff8c00;--acc2:#ff6600;--border:#ff8c0022;--text:#ffe0b2;--text2:#aa7040}
body.t-green{--bg:#001a0a;--bg2:#002a12;--bg3:#00150a;--acc:#00e676;--acc2:#00c853;--border:#00e67622;--text:#b9f6ca;--text2:#4a8a5a}
body.t-purple{--bg:#0d0014;--bg2:#160020;--bg3:#0a0010;--acc:#d500f9;--acc2:#aa00ff;--border:#d500f922;--text:#f3e5f5;--text2:#9060a0}
body.t-navy{--bg:#000d1a;--bg2:#001428;--bg3:#000a14;--acc:#00b4ff;--acc2:#0077cc;--border:#00b4ff22;--text:#cce8ff;--text2:#5080aa}

/* QUICK ADD OVERLAY */
.quick-fab{position:fixed;bottom:22px;left:22px;z-index:300;width:58px;height:58px;border-radius:50%;background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;color:#fff;font-size:1.7rem;cursor:pointer;box-shadow:0 4px 20px #00000066;display:none;align-items:center;justify-content:center;transition:transform 0.2s}
.quick-fab:active{transform:scale(0.92)}
.quick-overlay{display:none;position:fixed;inset:0;background:#00000088;z-index:299;align-items:flex-end;justify-content:center}
.quick-overlay.open{display:flex}
.quick-sheet{background:var(--bg2);border-radius:20px 20px 0 0;padding:20px 18px 32px;width:100%;max-width:480px;border-top:2px solid var(--acc)}
.quick-sheet h3{color:var(--acc);font-size:1rem;margin-bottom:14px;text-align:center}
.qs-row{display:flex;gap:8px;margin-bottom:10px}
.qs-inp{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:0.9rem;direction:rtl}
.qs-inp:focus{outline:none;border-color:var(--acc)}
.qs-sel{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:0.9rem;direction:rtl;margin-bottom:10px}
.qs-btn{width:100%;background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff;border:none;padding:13px;border-radius:10px;cursor:pointer;font-size:1rem;font-weight:700;margin-top:4px}
.qs-close{width:100%;background:transparent;border:1px solid var(--border);color:var(--text2);padding:10px;border-radius:10px;cursor:pointer;font-size:0.85rem;margin-top:8px}

/* NAV */
.nav{background:var(--bg2);border-bottom:2px solid color-mix(in srgb,var(--acc) 20%,transparent);display:flex;align-items:center;justify-content:space-between;padding:10px 14px;position:sticky;top:0;z-index:100}
.nav-title{font-size:1rem;font-weight:700;color:var(--text)}.nav-title span{color:var(--acc)}
.nav-right{display:flex;align-items:center;gap:6px}
.nb{background:color-mix(in srgb,var(--acc) 15%,transparent);border:1px solid color-mix(in srgb,var(--acc) 30%,transparent);color:var(--acc);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:0.75rem;font-weight:600}
.nb.ok{background:#00c85322;border-color:#00c85344;color:#00c853}
.nb.out{background:#ff174411;border-color:#ff174433;color:#ff1744}

/* TABS */
.tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{flex:1;min-width:68px;padding:11px 5px;text-align:center;cursor:pointer;font-size:0.72rem;color:var(--text2);border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.2s}
.tab.active{color:var(--acc);border-bottom-color:var(--acc)}

.main{padding:14px;max-width:560px;margin:0 auto;padding-bottom:88px}

/* CARDS */
.cards3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.card{background:var(--bg2);border-radius:12px;padding:12px 8px;border:1px solid var(--border);text-align:center;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;right:0;width:3px;height:100%}
.card.inc::before{background:var(--inc)}.card.exp::before{background:var(--exp)}.card.bal::before{background:var(--acc)}
.card h3{font-size:0.58rem;color:var(--text2);margin-bottom:5px;text-transform:uppercase;letter-spacing:0.5px}
.card .amt{font-size:1.05rem;font-weight:700}
.card.inc .amt{color:var(--inc)}.card.exp .amt{color:var(--exp)}.card.bal .amt{color:var(--acc)}

/* SECTION */
.sec{background:var(--bg2);border-radius:14px;padding:16px;margin-bottom:13px;border:1px solid var(--border)}
.sec h2{font-size:0.92rem;margin-bottom:13px;color:var(--text)}
.fg{margin-bottom:10px}
.fg label{display:block;font-size:0.72rem;color:var(--text2);margin-bottom:4px}
.fg input,.fg select{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:0.9rem;direction:rtl;-webkit-appearance:none}
.fg input:focus,.fg select:focus{outline:none;border-color:var(--acc)}
.fg select option{background:var(--bg2)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn-p{width:100%;background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff;border:none;padding:13px;border-radius:10px;cursor:pointer;font-size:0.95rem;font-weight:700;margin-top:4px}
.btn-p:disabled{opacity:0.4}
.btn-s{width:100%;background:transparent;color:var(--text2);border:1px solid var(--border);padding:11px;border-radius:10px;cursor:pointer;font-size:0.85rem;margin-top:8px}

/* TRANS */
.ti{background:var(--bg3);border-radius:10px;padding:11px 12px;margin-bottom:7px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border)}
.ti-cat{font-size:0.78rem;font-weight:600;margin-bottom:2px}
.ti-cat.inc{color:var(--inc)}.ti-cat.exp{color:var(--exp)}
.ti-sub{font-size:0.73rem;color:var(--text2)}
.ti-amt{font-size:1rem;font-weight:700;margin-right:8px}
.ti-amt.inc{color:var(--inc)}.ti-amt.exp{color:var(--exp)}
.frow2{display:flex;gap:7px;margin-bottom:12px;flex-wrap:wrap}
.fb{background:transparent;border:1px solid var(--border);color:var(--text2);padding:5px 12px;border-radius:20px;cursor:pointer;font-size:0.73rem}
.fb.active{background:color-mix(in srgb,var(--acc) 15%,transparent);border-color:var(--acc);color:var(--acc)}

/* CHARTS */
.chart-wrap{background:var(--bg3);border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid var(--border)}
.chart-wrap h4{font-size:0.8rem;color:var(--text2);margin-bottom:12px;text-align:center}
.chart-wrap canvas{max-height:220px}

/* SUMMARY TABLES */
.sum-cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.sum-c{background:var(--bg3);border-radius:10px;padding:13px;border:1px solid var(--border)}
.sum-c h4{font-size:0.7rem;color:var(--text2);margin-bottom:8px;text-transform:uppercase}
.sum-row{display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:5px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.sum-row:last-child{border:none;margin:0;padding:0}

/* SETTINGS */
.sg{margin-bottom:12px}
.sg label{display:block;font-size:0.72rem;color:var(--text2);margin-bottom:4px}
.sg input,.sg select{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:0.9rem}
.sg input:focus,.sg select:focus{outline:none;border-color:var(--acc)}
.ui{display:flex;justify-content:space-between;align-items:center;background:var(--bg3);border-radius:8px;padding:10px 12px;margin-bottom:6px}
.ui-role{font-size:0.7rem;color:var(--text2)}.ui-role.adm{color:var(--acc)}
.btn-rm{background:transparent;border:none;color:var(--exp);cursor:pointer;font-size:0.8rem}
.btn-au{width:100%;background:color-mix(in srgb,var(--acc) 15%,transparent);border:1px solid color-mix(in srgb,var(--acc) 30%,transparent);color:var(--acc);padding:9px;border-radius:8px;cursor:pointer;font-size:0.85rem;margin-top:8px}

/* THEME SWATCHES */
.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:4px}
.th-btn{border:2px solid transparent;border-radius:10px;padding:10px 4px;cursor:pointer;font-size:0.72rem;text-align:center;font-weight:600;transition:border-color 0.2s}
.th-btn.active{border-color:#fff}

/* LOGIN */
.login{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;text-align:center;background:var(--bg)}
.login h1{font-size:1.7rem;margin-bottom:6px;color:var(--text)}.login h1 span{color:var(--acc)}
.login p{color:var(--text2);margin-bottom:28px;font-size:0.9rem}
.lu-btn{width:100%;max-width:300px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:9px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:border-color 0.2s}
.lu-btn:active{border-color:var(--acc)}
.av{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--acc),var(--acc2));display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700;color:#fff;flex-shrink:0}
.av.adm{background:linear-gradient(135deg,#ffd700,#ff8c00)}
.lu-name{font-size:0.95rem;font-weight:600;color:var(--text);text-align:right}
.lu-role{font-size:0.72rem;color:var(--text2)}

/* PIN */
.pin{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;text-align:center;background:var(--bg)}
.pin h2{color:var(--text)}.pin p{color:var(--text2);font-size:0.85rem;margin-bottom:20px}
.pdots{display:flex;gap:10px;margin:14px 0 22px}
.pd{width:13px;height:13px;border-radius:50%;background:var(--border);transition:background 0.2s}
.pd.on{background:var(--acc)}
.ppad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:220px}
.pb{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:17px;font-size:1.2rem;font-weight:700;color:var(--text);cursor:pointer}
.pb:active{background:color-mix(in srgb,var(--acc) 20%,transparent)}
.perr{color:var(--exp);font-size:0.82rem;margin-top:10px;height:18px}

/* TOAST */
.toast{position:fixed;bottom:88px;left:50%;transform:translateX(-50%);background:var(--inc);color:#fff;padding:11px 22px;border-radius:10px;font-weight:600;z-index:999;opacity:0;transition:opacity 0.3s;pointer-events:none;font-size:0.85rem;white-space:nowrap}
.toast.on{opacity:1}.toast.err{background:var(--exp)}.toast.inf{background:var(--acc2)}

.page{display:none}.page.active{display:block}
.empty{text-align:center;padding:26px;color:var(--text2);font-size:0.85rem}
.info-box{background:color-mix(in srgb,var(--acc) 10%,transparent);border:1px solid color-mix(in srgb,var(--acc) 25%,transparent);border-radius:10px;padding:12px;margin-bottom:13px;font-size:0.8rem;color:var(--text2);line-height:1.7}
.info-box strong{color:var(--acc)}
</style>
</head>
<body class="t-dark">

<!-- QUICK ADD FAB -->
<button class="quick-fab" id="qFab" onclick="openQuick()">âš¡</button>

<!-- QUICK OVERLAY -->
<div class="quick-overlay" id="qOverlay">
  <div class="quick-sheet">
    <h3>âš¡ ×”×•×¡×¤×” ××”×™×¨×”</h3>
    <select class="qs-sel" id="qType" onchange="updQCats()">
      <option value="expense">×”×•×¦××”</option>
      <option value="income">×”×›× ×¡×”</option>
    </select>
    <select class="qs-sel" id="qCat"></select>
    <div class="qs-row">
      <input class="qs-inp" type="number" id="qAmt" placeholder="×¡×›×•× â‚ª" min="0">
      <input class="qs-inp" type="text" id="qDetail" placeholder="×¤×™×¨×•×˜">
    </div>
    <button class="qs-btn" onclick="quickAdd()">âš¡ ×©××•×¨</button>
    <button class="qs-close" onclick="closeQuick()">×‘×™×˜×•×œ</button>
  </div>
</div>

<!-- LOGIN -->
<div id="loginScreen" class="login">
  <h1>×ª×§×¦×™×‘ <span>××©×¤×—×ª×™</span> ğŸ </h1>
  <p>×‘×—×¨ ××ª ×”××©×ª××© ×©×œ×š</p>
  <div id="loginUsers"></div>
</div>

<!-- PIN -->
<div id="pinScreen" class="pin" style="display:none">
  <h2 id="pinTitle">×©×œ×•×</h2>
  <p>×”×–×Ÿ ×§×•×“ PIN</p>
  <div class="pdots" id="pdots"></div>
  <div class="ppad">
    <button class="pb" onclick="pp('1')">1</button><button class="pb" onclick="pp('2')">2</button><button class="pb" onclick="pp('3')">3</button>
    <button class="pb" onclick="pp('4')">4</button><button class="pb" onclick="pp('5')">5</button><button class="pb" onclick="pp('6')">6</button>
    <button class="pb" onclick="pp('7')">7</button><button class="pb" onclick="pp('8')">8</button><button class="pb" onclick="pp('9')">9</button>
    <button class="pb" onclick="pp('back')">âŒ«</button><button class="pb" onclick="pp('0')">0</button><button class="pb" onclick="pp('ok')">âœ“</button>
  </div>
  <div class="perr" id="perr"></div>
  <button class="btn-s" style="max-width:180px;margin-top:14px" onclick="backLogin()">×—×–×•×¨</button>
</div>

<!-- APP -->
<div id="appScreen" style="display:none">
  <div class="nav">
    <div class="nav-title">×ª×§×¦×™×‘ <span>××©×¤×—×ª×™</span></div>
    <div class="nav-right">
      <span id="uName" style="font-size:0.7rem;color:var(--text2)"></span>
      <button class="nb" id="odBtn" onclick="doAuth()">ğŸ”— OneDrive</button>
      <button class="nb out" onclick="doLogout()">×™×¦×™××”</button>
    </div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="goTab('dash',this)">ğŸ  ×‘×™×ª</div>
    <div class="tab" onclick="goTab('add',this)">â• ×”×•×¡×£</div>
    <div class="tab" onclick="goTab('hist',this)">ğŸ“‹ ×”×™×¡×˜×•×¨×™×”</div>
    <div class="tab" onclick="goTab('sum',this)">ğŸ“Š ×¡×™×›×•×</div>
    <div class="tab adm-tab" onclick="goTab('cfg',this)">âš™ï¸ ×”×’×“×¨×•×ª</div>
  </div>

  <div class="main">

    <!-- DASH -->
    <div id="tab-dash" class="page active">
      <div class="cards3">
        <div class="card inc"><h3>×”×›× ×¡×•×ª</h3><div class="amt" id="cInc">â‚ª0</div></div>
        <div class="card exp"><h3>×”×•×¦××•×ª</h3><div class="amt" id="cExp">â‚ª0</div></div>
        <div class="card bal"><h3>×™×ª×¨×”</h3><div class="amt" id="cBal">â‚ª0</div></div>
      </div>
      <div class="sec"><h2>âš¡ ×¢×¡×§××•×ª ××—×¨×•× ×•×ª</h2><div id="recentList"><div class="empty">××™×Ÿ ×¢×¡×§××•×ª ×¢×“×™×™×Ÿ</div></div></div>
    </div>

    <!-- ADD -->
    <div id="tab-add" class="page">
      <div class="sec">
        <h2>â• ×”×•×¡×£ ×¢×¡×§×”</h2>
        <div class="frow">
          <div class="fg"><label>×¡×•×’</label>
            <select id="fType" onchange="updCats()">
              <option value="expense">×”×•×¦××”</option>
              <option value="income">×”×›× ×¡×”</option>
            </select>
          </div>
          <div class="fg"><label>×ª××¨×™×š</label><input type="date" id="fDate"></div>
        </div>
        <div class="fg"><label>×§×˜×’×•×¨×™×”</label><select id="fCat"></select></div>
        <div class="frow">
          <div class="fg"><label>×¡×›×•× (â‚ª)</label><input type="number" id="fAmt" placeholder="0" min="0"></div>
          <div class="fg"><label>×¢×œ ×™×“×™</label><input type="text" id="fBy" placeholder="×©×"></div>
        </div>
        <div class="fg"><label>×¤×™×¨×•×˜</label><input type="text" id="fDetail" placeholder="×ª×™××•×¨ ×§×¦×¨"></div>
        <button class="btn-p" id="addBtn" onclick="addTx()">×©××•×¨ ×¢×¡×§×”</button>
        <button class="btn-s" onclick="clearForm()">× ×§×”</button>
      </div>
    </div>

    <!-- HIST -->
    <div id="tab-hist" class="page">
      <div class="frow2">
        <button class="fb active" onclick="setF('all',this)">×”×›×œ</button>
        <button class="fb" onclick="setF('income',this)">×”×›× ×¡×•×ª</button>
        <button class="fb" onclick="setF('expense',this)">×”×•×¦××•×ª</button>
      </div>
      <div id="txList"><div class="empty">××™×Ÿ ×¢×¡×§××•×ª</div></div>
    </div>

    <!-- SUMMARY -->
    <div id="tab-sum" class="page">
      <div class="sec">
        <h2>ğŸ“Š ×¡×™×›×•×</h2>
        <div class="frow" style="margin-bottom:14px">
          <div class="fg"><label>×—×•×“×©</label><select id="sMonth" onchange="renderSum()"></select></div>
          <div class="fg"><label>×©× ×”</label><select id="sYear" onchange="renderSum()"></select></div>
        </div>
        <div class="cards3" id="sumCards"></div>
      </div>
      <div class="chart-wrap"><h4>ğŸ“Š ×”×©×•×•××” ×—×•×“×©×™×ª â€” ×”×›× ×¡×•×ª ××•×œ ×”×•×¦××•×ª</h4><canvas id="chartBar"></canvas></div>
      <div class="chart-wrap"><h4>ğŸ¥§ ×”×•×¦××•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”</h4><canvas id="chartPie"></canvas></div>
      <div class="chart-wrap"><h4>ğŸ“ˆ ××’××” ×œ××•×¨×š ×–××Ÿ</h4><canvas id="chartLine"></canvas></div>
      <div class="sum-cards" id="sumTables"></div>
    </div>

    <!-- SETTINGS -->
    <div id="tab-cfg" class="page">
      <div class="sec">
        <h2>ğŸ”— ×”×’×“×¨×•×ª OneDrive</h2>
        <div class="info-box">××—×¨×™ ×©××™×¨×” â€” ×œ×—×¥ <strong>ğŸ”— OneDrive</strong> ×‘× ××‘ ×œ×”×ª×—×‘×¨×•×ª</div>
        <div class="sg"><label>Client ID (Azure)</label><input type="text" id="cClientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" dir="ltr"></div>
        <div class="sg"><label>×©× ×§×•×‘×¥ Excel</label><input type="text" id="cFile" placeholder="× ×™×¡×™×•×Ÿ ×œ××¤×œ×™×§×¦×™×”.xlsx"></div>
        <div class="sg"><label>×©× ×’×™×œ×™×•×Ÿ</label><input type="text" id="cSheet" placeholder="×”×•×¦××•×ª ×•×”×›× ×¡×•×ª"></div>
        <div class="sg"><label>×ª×™×§×™×™×” ×‘-OneDrive</label><input type="text" id="cFolder" placeholder="××©×•×ª×£"></div>
        <button class="btn-p" onclick="saveCfg()">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>
      </div>

      <div class="sec">
        <h2>ğŸ¨ ×¢×¨×›×ª × ×•×©×</h2>
        <div class="theme-grid" id="themeGrid"></div>
      </div>

      <div class="sec">
        <h2>ğŸ‘¥ ××©×ª××©×™×</h2>
        <div id="uList"></div>
        <button class="btn-au" onclick="showAddU()">+ ×”×•×¡×£ ××©×ª××©</button>
      </div>
      <div id="addUForm" class="sec" style="display:none">
        <h2>×”×•×¡×£ ××©×ª××©</h2>
        <div class="sg"><label>×©×</label><input type="text" id="nuName"></div>
        <div class="sg"><label>×ª×¤×§×™×“</label>
          <select id="nuRole">
            <option value="member">×‘×Ÿ ××©×¤×—×” (×”×–× ×” ×‘×œ×‘×“)</option>
            <option value="admin">××“××™×Ÿ</option>
          </select>
        </div>
        <div class="sg"><label>PIN (4 ×¡×¤×¨×•×ª)</label><input type="password" id="nuPin" maxlength="4" dir="ltr"></div>
        <button class="btn-p" onclick="addUser()">×”×•×¡×£</button>
        <button class="btn-s" onclick="document.getElementById('addUForm').style.display='none'">×‘×™×˜×•×œ</button>
      </div>
    </div>

  </div>
</div>
<div class="toast" id="toast"></div>

<script>
// â”€â”€ THEMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = [
  {id:'blue',   label:'ğŸ’™ ×›×—×•×œ',  acc:'#00d4ff', accD:'#0077ff'},
  {id:'gold',   label:'ğŸ† ×–×”×‘',   acc:'#ffd700', accD:'#ff8c00'},
  {id:'red',    label:'ğŸ”´ ××“×•×',  acc:'#ff4444', accD:'#cc0000'},
  {id:'orange', label:'ğŸŸ  ×›×ª×•×',  acc:'#ff8c00', accD:'#ff6600'},
  {id:'green',  label:'ğŸŒ¿ ×™×¨×•×§',  acc:'#00e676', accD:'#00c853'},
  {id:'purple', label:'ğŸ’œ ×¡×’×•×œ',  acc:'#d500f9', accD:'#aa00ff'},
  {id:'navy',   label:'ğŸŒŠ × ×™×™×‘×™', acc:'#00b4ff', accD:'#0077cc'},
  {id:'pink',   label:'ğŸŒ¸ ×•×¨×•×“',  acc:'#ff4081', accD:'#f50057'},
];
// theme = colorId + '-' + ('dark'|'light')
function getThemeVars(themeId){
  const [cid,mode]=themeId.split('-');
  const c=COLORS.find(x=>x.id===cid)||COLORS[0];
  const dark=mode!=='light';
  return dark ? {
    bg: '#0f0f1a', bg2:'#1a1a2e', bg3:'#0a0a14',
    acc:c.acc, acc2:c.accD,
    border:`${c.acc}18`, text:'#e0e0e0', text2:'#888',
    inc:'#00c853', exp:'#ff1744'
  } : {
    bg:'#f0f2f5', bg2:'#ffffff', bg3:'#e8eaf0',
    acc:c.accD, acc2:c.acc,
    border:'#d0d0d0', text:'#1a1a2e', text2:'#666',
    inc:'#00a040', exp:'#dd1133'
  };
}
const THEMES = COLORS.flatMap(c=>[
  {id:`${c.id}-dark`, label:c.label+' ×›×”×”', acc:c.acc, bg:'#0f0f1a'},
  {id:`${c.id}-light`,label:c.label+' ×‘×”×™×¨',acc:c.accD,bg:'#f0f2f5'},
]);

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let S = {
  users:[{id:1,name:'××“××™×Ÿ',role:'admin',pin:'1234',av:'×'}],
  txs:[],
  cats:{income:['×©×›×¨','×‘×•× ×•×¡','××—×¨'],expense:['××–×•×Ÿ','×©×›×™×¨×•×ª','×—×©×‘×•× ×•×ª','×ª×—×‘×•×¨×”','×‘×¨×™××•×ª','×‘×™×“×•×¨','×‘×™×’×•×“','×—×™× ×•×š','××—×¨']},
  cfg:{clientId:'',file:'× ×™×¡×™×•×Ÿ ×œ××¤×œ×™×§×¦×™×”.xlsx',sheet:'×”×•×¦××•×ª ×•×”×›× ×¡×•×ª',folder:'××©×•×ª×£'},
  theme:'t-dark'
};
let me=null,token=null,fMode='all',pinBuf='',pinFor=null;
let chartBar=null,chartPie=null,chartLine=null;

// â”€â”€ PERSIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save(){try{localStorage.setItem('bs',JSON.stringify(S));}catch(e){}}
function load(){try{const d=localStorage.getItem('bs');if(d)S={...S,...JSON.parse(d)};}catch(e){}}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload=()=>{
  load();
  if(location.hash.includes('access_token')){
    const p=new URLSearchParams(location.hash.substring(1));
    token=p.get('access_token');
    history.replaceState({},'',' ');
    sessionStorage.setItem('od_token',token);
    localStorage.setItem('od_token',token);
  }
  token=token||localStorage.getItem('od_token')||null;
  applyTheme(S.theme||'blue-dark');
  renderLogin();
  initSumFilters();
  document.getElementById('fDate').value=today();
};

function today(){return new Date().toISOString().split('T')[0];}
function fmt(n){return 'â‚ª'+Number(n||0).toLocaleString('he-IL');}

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme(t){
  S.theme=t||'blue-dark';
  const v=getThemeVars(S.theme);
  const root=document.documentElement;
  root.style.setProperty('--bg',v.bg);root.style.setProperty('--bg2',v.bg2);root.style.setProperty('--bg3',v.bg3);
  root.style.setProperty('--acc',v.acc);root.style.setProperty('--acc2',v.acc2);
  root.style.setProperty('--border',v.border);root.style.setProperty('--text',v.text);root.style.setProperty('--text2',v.text2);
  root.style.setProperty('--inc',v.inc);root.style.setProperty('--exp',v.exp);
  document.body.className='';
  document.querySelectorAll('.th-btn').forEach(b=>b.classList.toggle('active',b.dataset.t===S.theme));
}
function buildThemeGrid(){
  const g=document.getElementById('themeGrid');
  const parts=(S.theme||'blue-dark').split('-');
  const mode=parts[parts.length-1]==='light'?'light':'dark';
  const cid=parts.slice(0,-1).join('-');
  const darkSel=mode==='dark';
  let html=`<div style="grid-column:1/-1;display:flex;gap:8px;margin-bottom:10px">`;
  html+=`<button onclick="toggleMode('dark')" style="flex:1;padding:9px;border-radius:8px;border:2px solid ${darkSel?'#00d4ff':'#444'};background:${darkSel?'#1a1a2e':'transparent'};color:${darkSel?'#00d4ff':'#aaa'};cursor:pointer;font-size:0.82rem;font-weight:600">ğŸŒ‘ ×›×”×”</button>`;
  html+=`<button onclick="toggleMode('light')" style="flex:1;padding:9px;border-radius:8px;border:2px solid ${!darkSel?'#0077ff':'#444'};background:${!darkSel?'#e8eaf0':'transparent'};color:${!darkSel?'#0077ff':'#aaa'};cursor:pointer;font-size:0.82rem;font-weight:600">â˜€ï¸ ×‘×”×™×¨</button>`;
  html+=`</div>`;
  COLORS.forEach(c=>{
    const tid=c.id+'-'+mode;
    const isSel=S.theme===tid;
    html+=`<button class="th-btn${isSel?' active':''}" data-t="${tid}" onclick="setTheme('${tid}')" style="background:${mode==='dark'?'#1a1a2e':'#ffffff'};color:${c.acc};border:2px solid ${isSel?c.acc:c.acc+'44'};border-radius:10px;padding:10px 4px;cursor:pointer;font-size:0.72rem;font-weight:600;text-align:center">${c.label}</button>`;
  });
  g.innerHTML=html;
}
function toggleMode(m){const [cid]=( S.theme||'blue-dark').split('-');setTheme(`${cid}-${m}`);}
function setTheme(t){S.theme=t;save();applyTheme(t);buildThemeGrid();}

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLogin(){
  document.getElementById('loginUsers').innerHTML=S.users.map(u=>`
    <button class="lu-btn" onclick="selUser(${u.id})">
      <div class="av ${u.role==='admin'?'adm':''}">${u.av||u.name[0]}</div>
      <div style="text-align:right"><div class="lu-name">${u.name}</div><div class="lu-role">${u.role==='admin'?'××“××™×Ÿ':'×‘×Ÿ ××©×¤×—×”'}</div></div>
    </button>`).join('');
}
function selUser(id){
  pinFor=S.users.find(u=>u.id===id);if(!pinFor)return;
  pinBuf='';
  document.getElementById('pinTitle').textContent=`×©×œ×•× ${pinFor.name}`;
  renderPdots();
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('pinScreen').style.display='flex';
}
function renderPdots(){document.getElementById('pdots').innerHTML=[0,1,2,3].map(i=>`<div class="pd ${i<pinBuf.length?'on':''}"></div>`).join('');}
function pp(v){
  document.getElementById('perr').textContent='';
  if(v==='back'){pinBuf=pinBuf.slice(0,-1);renderPdots();return;}
  if(v!=='ok'&&pinBuf.length<4){pinBuf+=v;renderPdots();}
  if(pinBuf.length===4||v==='ok'){
    if(pinBuf===pinFor.pin){
      me=pinFor;
      document.getElementById('pinScreen').style.display='none';
      document.getElementById('appScreen').style.display='block';
      initApp();
    }else{document.getElementById('perr').textContent='×§×•×“ ×©×’×•×™';pinBuf='';renderPdots();}
  }
}
function backLogin(){document.getElementById('pinScreen').style.display='none';document.getElementById('loginScreen').style.display='flex';}

// â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initApp(){
  document.getElementById('uName').textContent=me.name;
  document.querySelectorAll('.adm-tab').forEach(e=>e.style.display=me.role==='admin'?'':'none');
  document.getElementById('qFab').style.display='flex';
  loadCfgForm();renderUsers();updCats();updQCats();
  if(token){document.getElementById('odBtn').textContent='âœ… ××—×•×‘×¨';document.getElementById('odBtn').classList.add('ok');syncFromExcel();}
  renderAll();
}
function doLogout(){
  me=null;token=null;sessionStorage.removeItem('od_token');localStorage.removeItem('od_token');
  document.getElementById('appScreen').style.display='none';
  document.getElementById('qFab').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('odBtn').textContent='ğŸ”— OneDrive';
  document.getElementById('odBtn').classList.remove('ok');
  renderLogin();
}
function renderAll(){updCards();renderRecent();renderTxList();}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doAuth(){
  if(!S.cfg.clientId){toast('×”×›× ×¡ Client ID ×‘×”×’×“×¨×•×ª','err');goTab('cfg',document.querySelectorAll('.tab')[4]);return;}
  const ru=window.location.href.split('#')[0].replace(/\/+$/,'');
  const url=`https://login.microsoftonline.com/consumers/oauth2/v2.0/authorize?client_id=${S.cfg.clientId}&response_type=token&redirect_uri=${encodeURIComponent(ru)}&scope=${encodeURIComponent('Files.ReadWrite User.Read')}&response_mode=fragment`;
  window.location.href=url;
}

// â”€â”€ EXCEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getFileId(){
  const r=await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURIComponent(S.cfg.folder)}/${encodeURIComponent(S.cfg.file)}`,{headers:{Authorization:'Bearer '+token}});
  const d=await r.json();if(!d.id)throw new Error(d.error?.message||'×§×•×‘×¥ ×œ× × ××¦×');return d.id;
}
async function syncFromExcel(){
  if(!token)return;
  try{
    toast('×˜×•×¢×Ÿ ×-Excel...','inf');
    const fid=await getFileId();
    const r=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fid}/workbook/worksheets/${encodeURIComponent(S.cfg.sheet)}/usedRange`,{headers:{Authorization:'Bearer '+token}});
    const d=await r.json();if(d.error)throw new Error(d.error.message);
    const rows=d.values||[];if(rows.length<2)return;
    const ic=[],ec=[];
    rows.slice(1).forEach(r=>{const cat=r[0],inc=parseFloat(r[2]),exp=parseFloat(r[3]);if(cat){if(inc>0&&!ic.includes(cat))ic.push(cat);if(exp>0&&!ec.includes(cat))ec.push(cat);}});
    if(ic.length)S.cats.income=[...new Set([...ic,'××—×¨'])];
    if(ec.length)S.cats.expense=[...new Set([...ec,'××—×¨'])];
    S.txs=rows.slice(1).filter(r=>r[0]||r[2]||r[3]).map((r,i)=>({id:i+1,category:r[0]||'',date:r[1]||'',income:parseFloat(r[2])||0,expense:parseFloat(r[3])||0,by:r[4]||'',detail:r[5]||''}));
    save();updCats();updQCats();renderAll();
    toast(`âœ… × ×˜×¢× ×• ${S.txs.length} ×¢×¡×§××•×ª`);
  }catch(e){toast('×©×’×™××”: '+e.message,'err');}
}
async function writeRow(tx){
  const fid=await getFileId();
  const r=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fid}/workbook/worksheets/${encodeURIComponent(S.cfg.sheet)}/usedRange`,{headers:{Authorization:'Bearer '+token}});
  const d=await r.json();if(d.error)throw new Error(d.error.message);
  const nr=(d.rowCount||1)+1;
  const w=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fid}/workbook/worksheets/${encodeURIComponent(S.cfg.sheet)}/range(address='A${nr}:F${nr}')`,{
    method:'PATCH',headers:{Authorization:'Bearer '+token,'Content-Type':'application/json'},
    body:JSON.stringify({values:[[tx.category,tx.date,tx.income||'',tx.expense||'',tx.by,tx.detail]]})
  });
  const wd=await w.json();if(wd.error)throw new Error(wd.error.message);
}

// â”€â”€ ADD TX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addTx(){
  const type=document.getElementById('fType').value;
  const date=document.getElementById('fDate').value;
  const cat=document.getElementById('fCat').value;
  const amt=parseFloat(document.getElementById('fAmt').value)||0;
  const by=document.getElementById('fBy').value.trim()||me.name;
  const detail=document.getElementById('fDetail').value.trim();
  if(!date||!cat||!amt){toast('× × ×œ××œ× ×ª××¨×™×š, ×§×˜×’×•×¨×™×” ×•×¡×›×•×','err');return;}
  const tx={id:Date.now(),category:cat,date,income:type==='income'?amt:0,expense:type==='expense'?amt:0,by,detail};
  S.txs.push(tx);save();renderAll();clearForm();
  if(token){
    const btn=document.getElementById('addBtn');btn.disabled=true;btn.textContent='×©×•××¨...';
    try{await writeRow(tx);toast('âœ… × ×©××¨ ×‘-Excel!');}catch(e){toast('× ×©××¨ ××§×•××™×ª â€” '+e.message,'err');}
    btn.disabled=false;btn.textContent='×©××•×¨ ×¢×¡×§×”';
  }else toast('âœ… ×¢×¡×§×” × ×•×¡×¤×”');
}
function clearForm(){document.getElementById('fCat').selectedIndex=0;document.getElementById('fAmt').value='';document.getElementById('fDetail').value='';document.getElementById('fDate').value=today();}

// â”€â”€ QUICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openQuick(){document.getElementById('qOverlay').classList.add('open');}
function closeQuick(){document.getElementById('qOverlay').classList.remove('open');}
function updQCats(){
  const type=document.getElementById('qType')?.value||'expense';
  const el=document.getElementById('qCat');
  if(el)el.innerHTML=(S.cats[type]||[]).map(c=>`<option>${c}</option>`).join('');
}
async function quickAdd(){
  const type=document.getElementById('qType').value;
  const cat=document.getElementById('qCat').value;
  const amt=parseFloat(document.getElementById('qAmt').value)||0;
  const detail=document.getElementById('qDetail').value.trim();
  if(!amt){toast('× × ×œ×”×–×™×Ÿ ×¡×›×•×','err');return;}
  const tx={id:Date.now(),category:cat,date:today(),income:type==='income'?amt:0,expense:type==='expense'?amt:0,by:me.name,detail};
  S.txs.push(tx);save();renderAll();
  document.getElementById('qAmt').value='';document.getElementById('qDetail').value='';
  closeQuick();
  if(token){try{await writeRow(tx);toast('âš¡ × ×©××¨!');}catch(e){toast('âš¡ × ×©××¨ ××§×•××™×ª','err');}}
  else toast('âš¡ × ×•×¡×£!');
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updCards(){
  const inc=S.txs.reduce((s,t)=>s+(t.income||0),0);
  const exp=S.txs.reduce((s,t)=>s+(t.expense||0),0);
  document.getElementById('cInc').textContent=fmt(inc);
  document.getElementById('cExp').textContent=fmt(exp);
  const bal=inc-exp;
  const el=document.getElementById('cBal');
  el.textContent=fmt(Math.abs(bal));
  el.style.color=bal>=0?'var(--acc)':'var(--exp)';
}
function txHTML(t){
  const tp=t.income>0?'inc':'exp';
  return `<div class="ti"><div style="flex:1"><div class="ti-cat ${tp}">${t.category} Â· ${t.date}</div><div class="ti-sub">${t.by}${t.detail?' Â· '+t.detail:''}</div></div><div class="ti-amt ${tp}">${tp==='inc'?'+':'-'}${fmt(t.income||t.expense)}</div></div>`;
}
function renderRecent(){
  const el=document.getElementById('recentList');
  const items=S.txs.slice(-6).reverse();
  el.innerHTML=items.length?items.map(txHTML).join(''):'<div class="empty">××™×Ÿ ×¢×¡×§××•×ª ×¢×“×™×™×Ÿ</div>';
}
function renderTxList(){
  const el=document.getElementById('txList');
  let list=S.txs.filter(t=>fMode==='income'?t.income>0:fMode==='expense'?t.expense>0:true).slice().reverse();
  el.innerHTML=list.length?list.map(txHTML).join(''):'<div class="empty">××™×Ÿ ×¢×¡×§××•×ª</div>';
}
function setF(f,btn){fMode=f;document.querySelectorAll('.fb').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderTxList();}
function updCats(){const type=document.getElementById('fType').value;document.getElementById('fCat').innerHTML=(S.cats[type]||[]).map(c=>`<option>${c}</option>`).join('');}

// â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSumFilters(){
  const ms=['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
  const m=new Date().getMonth()+1,y=new Date().getFullYear();
  document.getElementById('sMonth').innerHTML='<option value="all">×›×œ ×”×—×•×“×©×™×</option>'+ms.map((n,i)=>`<option value="${i+1}" ${i+1===m?'selected':''}>${n}</option>`).join('');
  document.getElementById('sYear').innerHTML=[y-1,y,y+1].map(yr=>`<option ${yr===y?'selected':''}>${yr}</option>`).join('');
}

function renderSum(){
  const month=document.getElementById('sMonth').value;
  const year=parseInt(document.getElementById('sYear').value);
  const txs=S.txs.filter(t=>{
    if(!t.date)return false;
    const d=new Date(t.date);
    if(d.getFullYear()!==year)return false;
    if(month!=='all'&&d.getMonth()+1!==parseInt(month))return false;
    return true;
  });
  const byCat={},byP={};
  let ti=0,te=0;
  txs.forEach(t=>{
    ti+=t.income||0;te+=t.expense||0;
    if(!byCat[t.category])byCat[t.category]={i:0,e:0};
    byCat[t.category].i+=t.income||0;byCat[t.category].e+=t.expense||0;
    const p=t.by||'?';if(!byP[p])byP[p]={i:0,e:0};
    byP[p].i+=t.income||0;byP[p].e+=t.expense||0;
  });

  // Summary cards
  document.getElementById('sumCards').innerHTML=`
    <div class="card inc"><h3>×”×›× ×¡×•×ª</h3><div class="amt" style="font-size:0.95rem">${fmt(ti)}</div></div>
    <div class="card exp"><h3>×”×•×¦××•×ª</h3><div class="amt" style="font-size:0.95rem">${fmt(te)}</div></div>
    <div class="card bal"><h3>×™×ª×¨×”</h3><div class="amt" style="font-size:0.95rem;color:${ti-te>=0?'var(--acc)':'var(--exp)'}">${fmt(Math.abs(ti-te))}</div></div>`;

  // Tables
  document.getElementById('sumTables').innerHTML=`
    <div class="sum-c"><h4>×œ×¤×™ ×§×˜×’×•×¨×™×”</h4>
      ${Object.entries(byCat).map(([c,v])=>`<div class="sum-row"><span>${c}</span><b style="color:${v.i>0?'var(--inc)':'var(--exp)'}">${v.i>0?fmt(v.i):fmt(v.e)}</b></div>`).join('')||'<div class="empty">××™×Ÿ</div>'}
    </div>
    <div class="sum-c"><h4>×œ×¤×™ ××“×</h4>
      ${Object.entries(byP).map(([p,v])=>`<div class="sum-row"><span>${p}</span><b>${fmt(v.i+v.e)}</b></div>`).join('')||'<div class="empty">××™×Ÿ</div>'}
    </div>`;

  renderCharts(year);
}

function renderCharts(year){
  const ms=['×™× ×•','×¤×‘×¨','××¨×¥','××¤×¨','×××™','×™×•× ','×™×•×œ','××•×’','×¡×¤×˜','××•×§','× ×•×‘','×“×¦×'];
  const incData=Array(12).fill(0),expData=Array(12).fill(0);
  S.txs.filter(t=>t.date&&new Date(t.date).getFullYear()===year).forEach(t=>{
    const m=new Date(t.date).getMonth();
    incData[m]+=t.income||0;expData[m]+=t.expense||0;
  });

  const acc=getComputedStyle(document.body).getPropertyValue('--acc').trim()||'#00d4ff';
  const inc=getComputedStyle(document.body).getPropertyValue('--inc').trim()||'#00c853';
  const exp=getComputedStyle(document.body).getPropertyValue('--exp').trim()||'#ff1744';

  const opts={responsive:true,plugins:{legend:{labels:{color:'#aaa',font:{size:11}}},tooltip:{callbacks:{label:c=>' '+fmt(c.raw)}}},scales:{x:{ticks:{color:'#888',font:{size:10}},grid:{color:'#ffffff08'}},y:{ticks:{color:'#888',font:{size:10},callback:v=>'â‚ª'+v.toLocaleString()},grid:{color:'#ffffff08'}}}};

  // Bar
  if(chartBar)chartBar.destroy();
  chartBar=new Chart(document.getElementById('chartBar'),{
    type:'bar',
    data:{labels:ms,datasets:[{label:'×”×›× ×¡×•×ª',data:incData,backgroundColor:inc+'99',borderColor:inc,borderWidth:1},{label:'×”×•×¦××•×ª',data:expData,backgroundColor:exp+'99',borderColor:exp,borderWidth:1}]},
    options:{...opts,plugins:{...opts.plugins}}
  });

  // Pie
  const month=document.getElementById('sMonth').value;
  const byCat={};
  S.txs.filter(t=>{
    if(!t.date||!t.expense)return false;
    const d=new Date(t.date);
    if(d.getFullYear()!==year)return false;
    if(month!=='all'&&d.getMonth()+1!==parseInt(month))return false;
    return true;
  }).forEach(t=>{byCat[t.category]=(byCat[t.category]||0)+t.expense;});
  const pieColors=['#ff1744','#ff5722','#ff9800','#ffc107','#8bc34a','#00bcd4','#2196f3','#9c27b0','#e91e63'];
  if(chartPie)chartPie.destroy();
  chartPie=new Chart(document.getElementById('chartPie'),{
    type:'doughnut',
    data:{labels:Object.keys(byCat),datasets:[{data:Object.values(byCat),backgroundColor:pieColors,borderColor:'#0f0f1a',borderWidth:2}]},
    options:{responsive:true,plugins:{legend:{position:'bottom',labels:{color:'#aaa',font:{size:10},boxWidth:12}}}}
  });

  // Line
  if(chartLine)chartLine.destroy();
  chartLine=new Chart(document.getElementById('chartLine'),{
    type:'line',
    data:{labels:ms,datasets:[
      {label:'×”×›× ×¡×•×ª',data:incData,borderColor:inc,backgroundColor:inc+'22',fill:true,tension:0.4,pointRadius:4},
      {label:'×”×•×¦××•×ª',data:expData,borderColor:exp,backgroundColor:exp+'22',fill:true,tension:0.4,pointRadius:4}
    ]},
    options:{...opts}
  });
}

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadCfgForm(){
  document.getElementById('cClientId').value=S.cfg.clientId||'';
  document.getElementById('cFile').value=S.cfg.file||'';
  document.getElementById('cSheet').value=S.cfg.sheet||'';
  document.getElementById('cFolder').value=S.cfg.folder||'';
}
function saveCfg(){
  S.cfg={clientId:document.getElementById('cClientId').value.trim(),file:document.getElementById('cFile').value.trim(),sheet:document.getElementById('cSheet').value.trim(),folder:document.getElementById('cFolder').value.trim()};
  save();toast('âœ… ×”×’×“×¨×•×ª × ×©××¨×•');
}
function renderUsers(){
  document.getElementById('uList').innerHTML=S.users.map(u=>`
    <div class="ui"><div><div>${u.name}</div><div class="ui-role ${u.role==='admin'?'adm':''}">${u.role==='admin'?'××“××™×Ÿ':'×‘×Ÿ ××©×¤×—×”'}</div></div>
    ${u.id!==me?.id?`<button class="btn-rm" onclick="removeUser(${u.id})">×”×¡×¨</button>`:'<span style="font-size:0.7rem;color:var(--text2)">××ª×”</span>'}</div>`).join('');
}
function showAddU(){document.getElementById('addUForm').style.display='block';}
function addUser(){
  const n=document.getElementById('nuName').value.trim();
  const r=document.getElementById('nuRole').value;
  const p=document.getElementById('nuPin').value.trim();
  if(!n||p.length!==4||isNaN(p)){toast('× × ×œ××œ× ×©× ×•-PIN ×©×œ 4 ×¡×¤×¨×•×ª','err');return;}
  S.users.push({id:Date.now(),name:n,role:r,pin:p,av:n[0]});
  save();renderUsers();
  document.getElementById('addUForm').style.display='none';
  document.getElementById('nuName').value='';document.getElementById('nuPin').value='';
  toast('××©×ª××© × ×•×¡×£!');
}
function removeUser(id){S.users=S.users.filter(u=>u.id!==id);save();renderUsers();}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goTab(name,btn){
  if(name==='cfg'&&me?.role!=='admin')return;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
  if(name==='sum')renderSum();
  if(name==='cfg')buildThemeGrid();
}
function toast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast on'+(type?' '+type:'');
  setTimeout(()=>t.className='toast',3000);
}
</script>
</body>
</html>
